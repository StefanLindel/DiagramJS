<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<title>DiagramJS - Simple Example</title>
	<link href="style.css" rel="stylesheet" type="text/css">
</head>

<body>
	<div class="toolbar">
		<h1 class="logo">DiagramJS</h1>
		<button id="layoutBtn">AUTO-LAYOUT</button>
	</div>
	<div class="diagram" id="canvas"></div>
	<script src="../dist/diagram.js" type="text/javascript"></script>
	<script src="dagre.js" type="text/javascript"></script>
	<script language="javascript">
	var data = {
	  typ: 'clazzdiagram',
	  nodes: [
	    {
	      type: 'clazz',
	      name: 'User',
	      attributes: [ '+ name : string', '+ address : string', '- id : int'],
	      methods: [ '+ register()', '+ login()' ]
	    },
	    {
	      type: 'clazz',
	      name: 'Order',
	      attributes: [ '+ status : string', '+ date : string', '- orderId : int'],
	      methods: [ '+ place()', '+ cancel()', '+ refund()' ]
	    },
	    {
	      type: 'clazz',
	      name: 'Account',
	      attributes: [ '- id : int']
	    },
	    {
	      type: 'clazz',
	      name: 'Product',
	      attributes: [ '+ name : string', '+ description : string', '+ photo : string', '- id : int'],
	      methods: [ '+ addToOrder()' ]
	    },
	    {
	      type: 'clazz',
	      name: 'Payment',
	      attributes: [ '+ provider : string', '+ amount : string' ],
	      methods: [ '+ getStatus()' ]
	    }
	  ],
	  edges: [
	    { type: 'edge', source: 'Order', target: 'Product' },
	    { type: 'edge', source: 'User', target: 'Order' },
	    { type: 'edge', source: 'User', target: 'Account' },
	    { type: 'edge', source: 'Order', target: 'Payment' },
	    { type: 'edge', source: 'Payment', target: 'Account' }
	  ]
	};

	var options = {
	  canvas: 'canvas',
	  origin: new Point(150, 45),
	  layout: "DagreLayout",
	  features: {
	    drag: true,
	    editor: true,
	    palette: true,
	    select: true,
	    zoom: true
	  }
	};

	var dia = new Graph(data, options);

	document.getElementById('layoutBtn').onclick = function () {
	  dia.layout();
	};

	//(function() {
	  dia.layout();
	//})();

		function handleLoadFile(evt) {
				evt.stopPropagation();
				evt.preventDefault();
		
				var files = evt.dataTransfer.files; // FileList object.
		
				if(files.length > 1){
					evt.dataTransfer.dropEffect = 'none';
					return;
				}

				// files is a FileList of File objects. List some properties.
				var reader  = new FileReader();
				var output = [];
				var htmlResult = '';
				for (var i = 0, f; f = files[i]; i++) {
						reader.onload = function(event){
								htmlResult = event.target.result;
								console.log("fileContent: " + htmlResult);
						
								var rootElement = document.getElementById("root");
								var canvasElement = document.getElementById("canvas");
								var palete = document.getElementById('palette');
								var rootChildCount = rootElement.childElementCount;

								for(var i = 0; i < rootChildCount; i++){
									rootElement.removeChild(rootElement.firstChild);
								}

								canvasElement.removeChild(canvasElement.firstChild);
								document.body.removeChild(palete);

								
								rootElement = null;
								canvasElement = null;
								palete = null;

								if(dia){
									dia.ClearModel();
								}

								var jsonData = JSON.parse(htmlResult);
								dia = new Graph(jsonData, options);
								dia.layout();
						};

						reader.readAsText(f);
				}

				evt.target.className = 'diagram';
			}
		
			function handleDragOver(evt) {
				evt.stopPropagation();
				evt.preventDefault();
				evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
				evt.target.className += ' diagramLoadFile';
				console.log("handDragOver");
			}

			function handleDragLeave(evt) {
				evt.stopPropagation();
				evt.preventDefault();
				evt.dataTransfer.dropEffect = 'link'; // Explicitly show this is a copy.
				evt.target.className = 'diagram';
				console.log("handDragLeave");
			}


			var dropZone = document.getElementById('canvas');
			dropZone.addEventListener('dragover', handleDragOver, false);
			dropZone.addEventListener('dragleave', handleDragLeave, false);
			dropZone.addEventListener('drop', handleLoadFile, false);

	</script>
</body>

</html>
